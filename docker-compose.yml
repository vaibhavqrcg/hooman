# Qdrant and MongoDB: shared by both dev and prod (no profile = always run with any profile)
services:
  qdrant:
    image: qdrant/qdrant:v1.7.4
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334

  mongodb:
    image: mongo:7
    volumes:
      - mongodb_data:/data/db

  # --- Development profile: API + React dev servers ---
  api-dev:
    profiles:
      - dev
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    working_dir: /app/apps/api
    ports:
      - "3000:3000"
    environment:
      DEBUG: hooman:*
      MONGO_URI: mongodb://mongodb:27017
      NODE_ENV: development
      QDRANT_URL: http://qdrant:6333
    volumes:
      - ./apps/api:/app/apps/api
      - api_data:/app/apps/api/data
    depends_on:
      qdrant:
        condition: service_started
      mongodb:
        condition: service_started
    command: ["npx", "tsx", "watch", "src/index.ts"]

  web-dev:
    profiles:
      - dev
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    working_dir: /app/apps/web
    ports:
      - "5173:5173"
    environment:
      VITE_PROXY_TARGET: http://api-dev:3000
    volumes:
      - ./apps/web:/app/apps/web
    depends_on:
      - api-dev
    command: ["npx", "vite", "--host", "0.0.0.0"]

  # --- Production profile: API + nginx serving built React ---
  api:
    profiles:
      - prod
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    ports:
      - "3000:3000"
    environment:
      MONGO_URI: mongodb://mongodb:27017
      NODE_ENV: production
      QDRANT_URL: http://qdrant:6333
    volumes:
      - api_data:/app/apps/api/data
    depends_on:
      qdrant:
        condition: service_started
      mongodb:
        condition: service_started

  web:
    profiles:
      - prod
    build:
      context: .
      dockerfile: Dockerfile
      target: web
    ports:
      - "5173:80"
    depends_on:
      - api

volumes:
  qdrant_data: {}
  mongodb_data: {}
  api_data: {}
